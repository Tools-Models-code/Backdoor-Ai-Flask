{% extends 'base.html' %}

{% block title %}Backdoor AI - Chat{% endblock %}

{% block head %}
<!-- No additional styles needed as they're in the main CSS file -->
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-9">
        <div class="card shadow-custom mb-4">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-comment-dots me-2"></i> Chat with Backdoor AI
                    </h5>
                    <div id="agent-status-container" class="agent-status">
                        <div class="status-indicator warning"></div>
                        <div class="status-text">Checking status...</div>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="alert alert-warning api-key-warning m-3 fade-in" style="display: none;">
                    <i class="fas fa-exclamation-triangle me-2"></i> 
                    <strong>API Key Required:</strong> Please set your Together AI API key in the 
                    <a href="{{ url_for('main.settings') }}" class="alert-link">settings</a> to use the chat.
                </div>
                
                <div class="chat-container">
                    <div class="chat-messages" id="chat-messages">
                        <div class="typing-indicator" id="typing-indicator">
                            <span class="typing-dot"></span>
                            <span class="typing-dot"></span>
                            <span class="typing-dot"></span>
                        </div>
                    </div>
                    
                    <div class="chat-input">
                        <form id="chat-form">
                            <div class="input-group">
                                <input type="text" id="user-input" class="form-control" placeholder="Type your message..." required>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane"></i> Send
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3">
        <!-- Token Usage Card -->
        <div class="card shadow-custom mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i> Usage Stats
                </h5>
            </div>
            <div class="card-body">
                <div id="token-usage-container" class="token-usage">
                    <div class="token-usage-title">Token Usage</div>
                    <div class="token-usage-stats">
                        <div class="token-stat">
                            <div class="token-value">0</div>
                            <div class="token-label">Prompt</div>
                        </div>
                        <div class="token-stat">
                            <div class="token-value">0</div>
                            <div class="token-label">Completion</div>
                        </div>
                        <div class="token-stat">
                            <div class="token-value">0</div>
                            <div class="token-label">Total</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions Card -->
        <div class="card shadow-custom mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bolt me-2"></i> Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="clearChat()">
                        <i class="fas fa-trash-alt me-2"></i> Clear Chat
                    </button>
                    <a href="{{ url_for('main.download_chat') }}" class="btn btn-outline-primary">
                        <i class="fas fa-download me-2"></i> Download Chat
                    </a>
                    <a href="{{ url_for('main.settings') }}" class="btn btn-outline-primary">
                        <i class="fas fa-cog me-2"></i> Settings
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/chat.js') }}"></script>
<script>
    // Store API keys and chat history
    const apiKey = "{{ together_api_key }}";
    const githubToken = "{{ github_token }}";
    let chatHistory = {{ chat_history|tojson|safe if chat_history else '[]' }};
    
    // DOM elements
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');
    const typingIndicator = document.getElementById('typing-indicator');
    const apiKeyWarning = document.querySelector('.api-key-warning');
    const tokenUsageContainer = document.getElementById('token-usage-container');
    const agentStatusContainer = document.getElementById('agent-status-container');
    
    // Check if API key is set
    if (!apiKey) {
        apiKeyWarning.style.display = 'block';
    }
    
    // Display chat history
    function displayChatHistory() {
        // Keep the typing indicator but remove other messages
        const messages = chatMessages.querySelectorAll('.message');
        messages.forEach(msg => msg.remove());
        
        chatHistory.forEach(message => {
            addMessageToUI(message.role, message.content, message.timestamp);
        });
        
        // Scroll to bottom
        scrollToBottom();
    }
    
    // Add a message to the UI
    function addMessageToUI(role, content, timestamp) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', 'p-3', 'mb-3');
        
        if (role === 'user') {
            messageDiv.classList.add('user-message');
        } else if (role === 'assistant') {
            messageDiv.classList.add('assistant-message');
        }
        
        // Create content container
        const contentDiv = document.createElement('div');
        
        // Format content with markdown for assistant messages
        if (role === 'assistant') {
            contentDiv.classList.add('markdown-content');
            contentDiv.innerHTML = marked.parse(content);
        } else {
            contentDiv.textContent = content;
        }
        
        messageDiv.appendChild(contentDiv);
        
        // Add timestamp if available
        if (timestamp) {
            const timeDiv = document.createElement('div');
            timeDiv.classList.add('message-time', 'text-muted', 'small');
            timeDiv.textContent = timestamp;
            messageDiv.appendChild(timeDiv);
        }
        
        // Insert before typing indicator
        chatMessages.insertBefore(messageDiv, typingIndicator);
        
        // Apply syntax highlighting to code blocks
        if (role === 'assistant') {
            messageDiv.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        }
        
        // Scroll to bottom
        scrollToBottom();
    }
    
    // Scroll chat to bottom
    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Show typing indicator
    function showTypingIndicator() {
        typingIndicator.style.display = 'block';
        scrollToBottom();
    }
    
    // Hide typing indicator
    function hideTypingIndicator() {
        typingIndicator.style.display = 'none';
    }
    
    // Send message to API
    async function sendMessage(message) {
        showTypingIndicator();
        
        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    api_key: apiKey,
                    history: chatHistory,
                    context: {
                        currentScreen: 'Chat',
                        appVersion: '1.0.0',
                        deviceType: 'Web',
                        osVersion: navigator.userAgent
                    }
                })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                // Update chat history
                chatHistory = data.history;
                
                // Hide typing indicator
                hideTypingIndicator();
                
                // Display the new messages (should be the last two in the history)
                if (chatHistory.length >= 2) {
                    // Clear existing messages and display full history
                    displayChatHistory();
                }
                
                // Update token usage
                updateTokenUsage();
            } else {
                hideTypingIndicator();
                
                // Show error message
                const timestamp = new Date().toLocaleString();
                addMessageToUI('assistant', `Error: ${data.error}`, timestamp);
            }
        } catch (error) {
            hideTypingIndicator();
            
            // Show error message
            const timestamp = new Date().toLocaleString();
            addMessageToUI('assistant', `Error: ${error.message}`, timestamp);
        }
    }
    
    // Update token usage display
    function updateTokenUsage() {
        fetch('/api/token-usage')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.token_usage) {
                    const usage = data.token_usage;
                    tokenUsageContainer.innerHTML = `
                        <div class="token-usage-title">Token Usage</div>
                        <div class="token-usage-stats">
                            <div class="token-stat">
                                <div class="token-value">${usage.prompt_tokens.toLocaleString()}</div>
                                <div class="token-label">Prompt</div>
                            </div>
                            <div class="token-stat">
                                <div class="token-value">${usage.completion_tokens.toLocaleString()}</div>
                                <div class="token-label">Completion</div>
                            </div>
                            <div class="token-stat">
                                <div class="token-value">${usage.total_tokens.toLocaleString()}</div>
                                <div class="token-label">Total</div>
                            </div>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error fetching token usage:', error);
            });
    }
    
    // Update agent status
    function updateAgentStatus() {
        fetch('/api/agent-status')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.status) {
                    const status = data.status;
                    let statusClass = status.ready ? 'ready' : 'warning';
                    let statusText = status.ready ? 'Agent Ready' : 'Agent Not Ready';
                    
                    if (!status.api_key_set) {
                        statusClass = 'error';
                        statusText = 'API Key Missing';
                    } else if (!status.initialized) {
                        statusText = 'Initializing...';
                    }
                    
                    agentStatusContainer.innerHTML = `
                        <div class="status-indicator ${statusClass}"></div>
                        <div class="status-text">${statusText}</div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error fetching agent status:', error);
                agentStatusContainer.innerHTML = `
                    <div class="status-indicator error"></div>
                    <div class="status-text">Connection Error</div>
                `;
            });
    }
    
    // Clear chat history
    function clearChat() {
        if (confirm('Are you sure you want to clear the chat history?')) {
            chatHistory = [];
            displayChatHistory();
            
            // Add welcome message
            const timestamp = new Date().toLocaleString();
            const welcomeMessage = "Hello! I'm Backdoor AI, your assistant for the Backdoor app. I can help you with app signing, source management, and other app-related tasks. How can I assist you today?";
            
            // Add to UI
            addMessageToUI('assistant', welcomeMessage, timestamp);
            
            // Add to history
            chatHistory.push({
                role: 'assistant',
                content: welcomeMessage,
                timestamp: timestamp
            });
            
            // Show success message
            showToast('Chat history cleared successfully!');
        }
    }
    
    // Show toast notification
    function showToast(message, type = 'success') {
        // Create toast container if it doesn't exist
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        // Create toast element
        const toastEl = document.createElement('div');
        toastEl.className = `toast align-items-center text-white bg-${type} border-0`;
        toastEl.setAttribute('role', 'alert');
        toastEl.setAttribute('aria-live', 'assertive');
        toastEl.setAttribute('aria-atomic', 'true');
        
        // Create toast content
        toastEl.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        
        // Add to container
        toastContainer.appendChild(toastEl);
        
        // Initialize and show the toast
        const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
        toast.show();
        
        // Remove toast after it's hidden
        toastEl.addEventListener('hidden.bs.toast', function() {
            toastEl.remove();
        });
    }
    
    // Handle form submission
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const message = userInput.value.trim();
        if (!message) return;
        
        // Clear input
        userInput.value = '';
        
        // Add user message to UI immediately
        const timestamp = new Date().toLocaleString();
        addMessageToUI('user', message, timestamp);
        
        // Send to API
        sendMessage(message);
    });
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        // Display chat history
        displayChatHistory();
        
        // Add welcome message if history is empty
        if (chatHistory.length === 0) {
            const timestamp = new Date().toLocaleString();
            const welcomeMessage = "Hello! I'm Backdoor AI, your assistant for the Backdoor app. I can help you with app signing, source management, and other app-related tasks. How can I assist you today?";
            
            // Add to UI
            addMessageToUI('assistant', welcomeMessage, timestamp);
            
            // Add to history
            chatHistory.push({
                role: 'assistant',
                content: welcomeMessage,
                timestamp: timestamp
            });
        }
        
        // Initialize token usage display
        updateTokenUsage();
        
        // Initialize agent status
        updateAgentStatus();
        
        // Set up polling for agent status and token usage
        setInterval(updateAgentStatus, 10000); // Every 10 seconds
        setInterval(updateTokenUsage, 30000);  // Every 30 seconds
    });
</script>
{% endblock %}