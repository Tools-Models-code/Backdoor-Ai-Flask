{% extends 'base.html' %}

{% block title %}Backdoor AI - Chat{% endblock %}

{% block head %}
<style>
    .chat-container {
        height: calc(100vh - 250px);
        display: flex;
        flex-direction: column;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 0.5rem;
    }
    
    .chat-input {
        margin-top: 1rem;
    }
    
    .message {
        margin-bottom: 1rem;
        padding: 0.75rem;
        border-radius: 0.5rem;
        max-width: 80%;
    }
    
    .user-message {
        background-color: #007bff;
        color: white;
        margin-left: auto;
    }
    
    .assistant-message {
        background-color: #e9ecef;
        color: #212529;
        margin-right: auto;
    }
    
    .message-time {
        font-size: 0.75rem;
        opacity: 0.7;
        margin-top: 0.25rem;
    }
    
    .typing-indicator {
        display: none;
        background-color: #e9ecef;
        padding: 0.5rem 1rem;
        border-radius: 1rem;
        margin-bottom: 1rem;
        width: fit-content;
    }
    
    .typing-dot {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #777;
        margin-right: 3px;
        animation: typing 1.4s infinite ease-in-out;
    }
    
    .typing-dot:nth-child(1) { animation-delay: 0s; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes typing {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-5px); }
    }
    
    .markdown-content pre {
        background-color: #f5f5f5;
        padding: 1rem;
        border-radius: 0.25rem;
        overflow-x: auto;
    }
    
    .markdown-content code {
        font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 0.875em;
    }
    
    .markdown-content p {
        margin-bottom: 1rem;
    }
    
    .markdown-content ul, .markdown-content ol {
        margin-bottom: 1rem;
        padding-left: 2rem;
    }
    
    .markdown-content h1, .markdown-content h2, .markdown-content h3, 
    .markdown-content h4, .markdown-content h5, .markdown-content h6 {
        margin-top: 1.5rem;
        margin-bottom: 1rem;
    }
    
    .api-key-warning {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-chat-dots"></i> Chat with Backdoor AI
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="alert alert-warning api-key-warning m-3">
                    <i class="bi bi-exclamation-triangle"></i> 
                    <strong>API Key Required:</strong> Please set your Together AI API key in the 
                    <a href="{{ url_for('main.settings') }}" class="alert-link">settings</a> to use the chat.
                </div>
                
                <div class="chat-container">
                    <div class="chat-messages" id="chat-messages">
                        <div class="typing-indicator">
                            <span class="typing-dot"></span>
                            <span class="typing-dot"></span>
                            <span class="typing-dot"></span>
                        </div>
                    </div>
                    
                    <div class="chat-input p-3">
                        <form id="chat-form">
                            <div class="input-group">
                                <input type="text" id="user-input" class="form-control" placeholder="Type your message..." required>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-send"></i> Send
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Store API keys and chat history
    const apiKey = "{{ together_api_key }}";
    const githubToken = "{{ github_token }}";
    let chatHistory = {{ chat_history|tojson|safe if chat_history else '[]' }};
    
    // DOM elements
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');
    const typingIndicator = document.querySelector('.typing-indicator');
    const apiKeyWarning = document.querySelector('.api-key-warning');
    
    // Check if API key is set
    if (!apiKey) {
        apiKeyWarning.style.display = 'block';
    }
    
    // Display chat history
    function displayChatHistory() {
        chatMessages.innerHTML = '';
        chatMessages.appendChild(typingIndicator);
        
        chatHistory.forEach(message => {
            addMessageToUI(message.role, message.content, message.timestamp);
        });
        
        // Scroll to bottom
        scrollToBottom();
    }
    
    // Add a message to the UI
    function addMessageToUI(role, content, timestamp) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message');
        
        if (role === 'user') {
            messageDiv.classList.add('user-message');
        } else if (role === 'assistant') {
            messageDiv.classList.add('assistant-message');
        }
        
        // Format content with markdown for assistant messages
        if (role === 'assistant') {
            const markdownContent = document.createElement('div');
            markdownContent.classList.add('markdown-content');
            markdownContent.innerHTML = marked.parse(content);
            messageDiv.appendChild(markdownContent);
        } else {
            messageDiv.textContent = content;
        }
        
        // Add timestamp if available
        if (timestamp) {
            const timeDiv = document.createElement('div');
            timeDiv.classList.add('message-time');
            timeDiv.textContent = timestamp;
            messageDiv.appendChild(timeDiv);
        }
        
        // Insert before typing indicator
        chatMessages.insertBefore(messageDiv, typingIndicator);
        
        // Apply syntax highlighting to code blocks
        if (role === 'assistant') {
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        }
        
        // Scroll to bottom
        scrollToBottom();
    }
    
    // Scroll chat to bottom
    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Show typing indicator
    function showTypingIndicator() {
        typingIndicator.style.display = 'block';
        scrollToBottom();
    }
    
    // Hide typing indicator
    function hideTypingIndicator() {
        typingIndicator.style.display = 'none';
    }
    
    // Send message to API
    async function sendMessage(message) {
        showTypingIndicator();
        
        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    api_key: apiKey,
                    history: chatHistory,
                    context: {
                        currentScreen: 'Chat',
                        appVersion: '1.0.0',
                        deviceType: 'Web',
                        osVersion: navigator.userAgent
                    }
                })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                // Update chat history
                chatHistory = data.history;
                
                // Hide typing indicator
                hideTypingIndicator();
                
                // Display the new messages (should be the last two in the history)
                if (chatHistory.length >= 2) {
                    const userMsg = chatHistory[chatHistory.length - 2];
                    const assistantMsg = chatHistory[chatHistory.length - 1];
                    
                    // Clear existing messages and display full history
                    displayChatHistory();
                }
            } else {
                hideTypingIndicator();
                
                // Show error message
                const timestamp = new Date().toLocaleString();
                addMessageToUI('assistant', `Error: ${data.error}`, timestamp);
            }
        } catch (error) {
            hideTypingIndicator();
            
            // Show error message
            const timestamp = new Date().toLocaleString();
            addMessageToUI('assistant', `Error: ${error.message}`, timestamp);
        }
    }
    
    // Handle form submission
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const message = userInput.value.trim();
        if (!message) return;
        
        // Clear input
        userInput.value = '';
        
        // Add user message to UI immediately
        const timestamp = new Date().toLocaleString();
        addMessageToUI('user', message, timestamp);
        
        // Send to API
        sendMessage(message);
    });
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        displayChatHistory();
        
        // Add welcome message if history is empty
        if (chatHistory.length === 0) {
            const timestamp = new Date().toLocaleString();
            const welcomeMessage = "Hello! I'm Backdoor AI, your assistant for the Backdoor app. I can help you with app signing, source management, and other app-related tasks. How can I assist you today?";
            
            // Add to UI
            addMessageToUI('assistant', welcomeMessage, timestamp);
            
            // Add to history
            chatHistory.push({
                role: 'assistant',
                content: welcomeMessage,
                timestamp: timestamp
            });
        }
    });
</script>
{% endblock %}